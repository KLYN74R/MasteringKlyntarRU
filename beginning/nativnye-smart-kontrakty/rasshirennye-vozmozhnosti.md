---
description: –ï—â—ë –Ω–µ–º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π –∏–Ω—Ñ—ã –ø—Ä–æ KLYNTAR VM
cover: ../../.gitbook/assets/4439981.jpg
coverY: -260.62833432128036
---

# üí™ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### <mark style="color:red;">**–ö–∞–∫ KLYNTAR —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤**</mark>

–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–º - –Ω–∞–º –≤–µ–¥—å –Ω–µ –Ω—É–∂–Ω–æ —á—Ç–æ–± –Ω–∞—à –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å–≥–æ—Ä–µ–ª –∏ –Ω–æ–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å. –ù—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å —Ç–æ—Ç —Ñ–∞–∫—Ç, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –±–∞–π—Ç-–∫–æ–¥–∞ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–ø—Ä—è—Ç–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –∏–ª–∏ –µ—â—ë –∫–∞–∫–∏–º-—Ç–æ –æ–±—Ä–∞–∑–æ–º –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã.

–ö—Ä–æ–º–µ —Ç–æ–≥–æ, –Ω–∞–¥–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏ —Ç–æ, —Å–∫–æ–ª—å–∫–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –±—É–¥–µ—Ç –ø–æ—Ç—Ä–∞—á–µ–Ω–æ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –Ω–æ–¥—ã. –í–µ–¥—å –∑–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É a+b —è–≤–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –º–µ–Ω—å—à–µ, —á–µ–º —Ü–∏–∫–ª —Å 10 000 –∏—Ç–µ—Ä–∞—Ü–∏–π.

–í KLYNTAR VM –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –æ—Ç EWASM –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤. –í–æ—Ç –∏—Ö GitHub

![](<../../.gitbook/assets/image (1) (2).png>)

{% embed url="https://github.com/ewasm" %}

–ù–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π _<mark style="color:red;">**wasm-metering**</mark>_ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä—å –±–∞–π—Ç-–∫–æ–¥–∞ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

![](<../../.gitbook/assets/image (1) (1) (1).png>)

–ù–∞ –≤—ã—Ö–æ–¥–µ –º—ã –ø–æ–ª—É—á–∏–º  –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É –±–∞–π—Ç-–∫–æ–¥, –Ω–æ —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ –∏ –∏–¥—ë—Ç —Ä–∞—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—á–∏–≤–∞–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤. –ü—Ä–æ–≤–µ–¥—ë–º –Ω–µ–±–æ–ª—å—à–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ

### <mark style="color:red;">**–†–∞–∑–±–∏—Ä–∞–µ–º—Å—è –¥–µ—Ç–∞–ª—å–Ω–µ–π**</mark>

–î–ª—è —ç—Ç–æ–≥–æ, –≤ README –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –ø—Ä–∏–º–µ—Ä:

```javascript
const fs = require('fs')
const metering = require('wasm-metering')

const wasm = fs.readFileSync('fac.wasm')
const meteredWasm = metering.meterWASM(wasm, {
  meterType: 'i32'
})

const limit = 90000000
let gasUsed = 0

const mod = WebAssembly.Module(meteredWasm.module)
const instance = WebAssembly.Instance(mod, {
  'metering': {
    'usegas': (gas) => {
      gasUsed += gas
      if (gasUsed > limit) {
        throw new Error('out of gas!')
      }
    }
  }
})

const result = instance.exports.fac(6)
console.log(`result:${result}, gas used ${gasUsed * 1e-4}`) // result:720, gas used 0.4177
```

–ó–¥–µ—Å—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è gasUsed –∏ –ª–∏–º–∏—Ç –≥–∞–∑–∞. –ö–∞–∫ –≤–∏–¥–Ω–æ –∏–∑ —ç—Ç–∏—Ö —Å—Ç—Ä–æ—á–µ–∫, –º–æ–¥—É–ª—å –±–µ—Ä—ë—Ç –≥–æ–ª—ã–π –±–∞–π—Ç-–∫–æ–¥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π –±–∞–π—Ç-–∫–æ–¥ –∫—É–¥–∞ –∏–Ω–∂–µ–∫—Ç–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é –∏–∑–≤–Ω–µ(–≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è _<mark style="color:purple;">**usegas**</mark>_ –∏–∑ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ _<mark style="color:red;">**metering**</mark>_).

–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ - —Ä–∞–±–æ—Ç–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∏ –º—ã –ª–æ–≤–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è. –•–æ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è EWASM –∏ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã, –º—ã –≤—Å—ë –∂–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ —É—Å–ª—ã—à–∏–º, –Ω–æ –∏ —É–≤–∏–¥–∏–º –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.

–ö—Å—Ç–∞—Ç–∏, –≤–æ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –∏ —Ö–æ—Ä–æ—à–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ GitHub

![](<../../.gitbook/assets/image (52).png>)

{% embed url="https://github.com/ewasm/design/blob/master/metering.md" %}

### <mark style="color:red;">–°–º–æ—Ç—Ä–∏–º –Ω–∞ –≤–∏–¥–æ–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π WASM –º–æ–¥—É–ª—å</mark>

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø—Ä–æ–∏–∑–æ–π–¥—É—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–¥ –Ω–∞—à–∏–º –º–æ–¥—É–ª–µ–º, –¥–∞–≤–∞–π—Ç–µ –∑–∞–ø–∏—à–µ–º —ç—Ç–æ—Ç –Ω–∞–±–æ—Ä –±–∞–π—Ç –≤ .wasm —Ñ–∞–π–ª, –∞ –∑–∞—Ç–µ–º –¥–µ–∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≤ .wat –æ—Ç–∫—É–¥–∞ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏

–ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π AssemblyScript –º–æ–¥—É–ª—å. –í—ã–±–µ—Ä–µ–º —á—Ç–æ-—Ç–æ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä —Ü–∏–∫–ª

```typescript
export function testAdding(a: i32, b: i32 ): i32 {

    let sum:i32 = 0;

    for(let i:i32=0;i<a;i++){

        sum+=b

    }

    return sum;
   
}
```

–•–æ—Ç—å —ç—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ —É–º–Ω–æ–∂–µ–Ω–∏–µ, –≤—Å—ë –∂–µ —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫.

–ü–æ–ª—É—á–∞–µ–º .wasm –∫–æ–¥

```
asc test.ts -o test.wasm -O3z
```

–ó–∞–ø–∏—Å—å –≤ .wasm

```javascript
import metering from 'wasm-metering'
import fs from 'fs'

const wasm = fs.readFileSync('test.wasm')

const meteredWasm = metering.meterWASM(wasm,{
    meterType: 'i32'
})

fs.writeFileSync('metered.wasm',meteredWasm)

console.log('Default module => ',wasm)
console.log('After injection => ',meteredWasm)
```

–ü–æ–ª—É—á–∏–º —Ç–∞–∫–æ–π –≤—ã–≤–æ–¥

```
Default module =>  <Buffer 00 61 73 6d 01 00 00 00 01 07 01 60 02 7f 7f 01 7f 03 02 01 00 05 03 01 00 00 07 17 02 0a 74 65 73 74 41 64 64 69 6e 67 00 00 06 6d 65 6d 6f 72 79 02 ... 38 more bytes>
After injection =>  <Buffer 00 61 73 6d 01 00 00 00 01 0b 02 60 02 7f 7f 01 7f 60 01 7f 00 02 13 01 08 6d 65 74 65 72 69 6e 67 06 75 73 65 67 61 73 00 01 03 02 01 00 05 03 01 00 ... 83 more bytes>
```

–í–∏–¥–Ω–æ —á—Ç–æ —Ä–∞–∑–º–µ—Ä —É–≤–µ–ª–∏—á–∏–ª—Å—è –∏ —Å–µ–π—á–∞—Å –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ –ø–æ—á–µ–º—É. –ü—Ä–µ–∂–¥–µ, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–±–æ—Ç—É

```javascript
import loader from '@assemblyscript/loader'
import metering from 'wasm-metering'
import fs from 'fs'

const wasm = fs.readFileSync('test.wasm')

const meteredWasm = metering.meterWASM(wasm,{
    meterType: 'i32'
})

const energyLimit = 2000000
let energyUsed = 0

let wasmMetered = await loader.instantiate(meteredWasm,{
    'metering': {
      'usegas': (energy) => {
        energyUsed += energy
        if (energyUsed > energyLimit) {
          throw new Error('No more energy!')
        }
      }
    }
});

const result = wasmMetered.exports.testAdding(8,20);

console.log(`Result:${result}, energy used ${energyUsed * 1e-4}`);
```

```
Result:160, energy used 1.0672000000000001
```

–î–µ–∫–æ–º–ø–∏–ª—è—Ü–∏—è –≤ .wat

```
wasm2wat metered.wasm
```

–ò —Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ñ–∞–π–ª

```wasm
(module
 (type $i32_=>_none (func (param i32)))
 (type $i32_i32_=>_i32 (func (param i32 i32) (result i32)))
 (import "metering" "usegas" (func $fimport$0 (param i32)))
 (memory $0 0)
 (export "testAdding" (func $0))
 (export "memory" (memory $0))
 (func $0 (param $0 i32) (param $1 i32) (result i32)
  (local $2 i32)
  (local $3 i32)
  (call $fimport$0
   (i32.const 92)
  )
  (loop $label$1
   (call $fimport$0
    (i32.const 377)
   )
   (if
    (i32.gt_s
     (local.get $0)
     (local.get $2)
    )
    (block
     (call $fimport$0
      (i32.const 872)
     )
     (local.set $3
      (i32.add
       (local.get $1)
       (local.get $3)
      )
     )
     (local.set $2
      (i32.add
       (local.get $2)
       (i32.const 1)
      )
     )
     (br $label$1)
    )
   )
  )
  (call $fimport$0
   (i32.const 211)
  )
  (local.get $3)
 )
)

```

–í–∏–¥–∏–º –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é

```wasm
 (import "metering" "usegas" (func $fimport$0 (param i32)))
```

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º –≤–µ–∑–¥–µ –≤ –∫–æ–¥–µ –≥–¥–µ –±—É–¥–µ—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è –≤—ã–∑–æ–≤ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, –º—ã –±—É–¥–µ–º –ø–æ–Ω–∏–º–∞—Ç—å —á—Ç–æ –∏–¥—ë—Ç —Å—á—ë—Ç –≥–∞–∑–∞(—ç–Ω–µ—Ä–≥–∏–∏). –¢–∞–∫ –º–æ–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é _<mark style="color:purple;">**testAdding**</mark>_, –≤ –Ω–∞—á–∞–ª–µ —Ü–∏–∫–ª–∞, –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.

–° –ø–æ–º–æ—â—å—é —ç—Ç–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –º–æ–∂–µ—Ç–µ —Å–∞–º–∏ –ø–æ–∏–≥—Ä–∞—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∫—É —Ä–∞–±–æ—Ç—ã

### <mark style="color:red;">**–ó–∞—á–µ–º –≤—Å—ë —ç—Ç–æ**</mark>

–ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —ç—Ç–∏—Ö –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∞–Ω–µ–µ –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –º—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–º –º–æ—â–Ω–æ—Å—Ç—å –∏ —Å–∏–ª—É –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π KLYNTAR.

–í—ã —Å–º–æ–∂–µ—Ç–µ —Å –ø–æ–º–æ—â—å—é —Ä–∞—Å—á—ë—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –Ω–∞–∑–Ω–∞—á–∞—Ç—å —Ü–µ–Ω—É –æ–ø–∫–æ–¥–∞–º –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–º –æ–±—ä–µ–∫—Ç–∞–º, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ä–∞–∑–Ω—ã–µ API –¥–ª—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ. –ö–∞–∂–¥—ã–π —Å–∏–º–±–∏–æ—Ç –º–æ–∂–µ—Ç —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É.

{% hint style="info" %}
–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –Ω–∏—á–µ–≥–æ –≤–∞–∂–Ω–æ–≥–æ
{% endhint %}

### <mark style="color:red;">**–°—Å—ã–ª–∫–∏**</mark>

{% embed url="https://ewasm.readthedocs.io/en/mkdocs/" %}
